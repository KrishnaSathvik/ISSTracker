<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ISS Live Tracker ‚Äî Real-time 3D</title>

    <!-- ‚îÄ‚îÄ SEO ‚îÄ‚îÄ -->
    <meta name="description" content="Track the International Space Station in real-time with a live 3D globe, telemetry data, altitude, velocity, and day/night visibility.">
    <meta name="author" content="Krishna Sathvik Mantripragada">
    <meta name="keywords" content="ISS tracker, International Space Station, real-time, 3D globe, live tracking, satellite">

    <!-- ‚îÄ‚îÄ Open Graph (Facebook, LinkedIn, WhatsApp, iMessage) ‚îÄ‚îÄ -->
    <meta property="og:type"        content="website">
    <meta property="og:url"         content="https://krishnasathvik.github.io/ISSTracker/">
    <meta property="og:title"       content="ISS Live Tracker ‚Äî Real-time 3D">
    <meta property="og:description" content="Watch the International Space Station orbit Earth in real-time. Live telemetry: position, altitude, velocity & visibility updated every 10 seconds.">
    <meta property="og:image"       content="https://upload.wikimedia.org/wikipedia/commons/thumb/0/04/ISS_Feb_2010.jpg/1280px-ISS_Feb_2010.jpg">
    <meta property="og:image:width"  content="1280">
    <meta property="og:image:height" content="854">
    <meta property="og:image:alt"   content="International Space Station orbiting Earth">

    <!-- ‚îÄ‚îÄ Twitter / X Card ‚îÄ‚îÄ -->
    <meta name="twitter:card"        content="summary_large_image">
    <meta name="twitter:title"       content="ISS Live Tracker ‚Äî Real-time 3D">
    <meta name="twitter:description" content="Watch the ISS orbit Earth live. Real-time position, altitude, velocity & day/night visibility on an interactive 3D globe.">
    <meta name="twitter:image"       content="https://upload.wikimedia.org/wikipedia/commons/thumb/0/04/ISS_Feb_2010.jpg/1280px-ISS_Feb_2010.jpg">

    <!-- ‚îÄ‚îÄ Favicon ‚îÄ‚îÄ -->
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üõ∞Ô∏è</text></svg>">

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=Share+Tech+Mono&family=Rajdhani:wght@300;400;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --void:      #020408;
            --amber:     #ffcc00;
            --teal:      #00ffff;
            --green:     #00ff99;
            --red:       #ff5555;
            --border:    rgba(255,204,0,0.45);
            --border-dim:rgba(255,255,255,0.1);
            --font-mono: 'Share Tech Mono', monospace;
            --font-ui:   'Rajdhani', sans-serif;
        }
        *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

        body {
            background: var(--void);
            color: var(--amber);
            font-family: var(--font-mono);
            overflow: hidden;
            cursor: crosshair;
        }
        canvas { display: block; position: fixed; inset: 0; z-index: 0; }

        /* scanlines */
        body::after {
            content: '';
            position: fixed; inset: 0;
            background: repeating-linear-gradient(0deg, transparent, transparent 2px, rgba(0,0,0,0.04) 2px, rgba(0,0,0,0.04) 4px);
            pointer-events: none;
            z-index: 999;
        }

        /* ‚îÄ‚îÄ BOOT SCREEN ‚îÄ‚îÄ */
        #boot-screen {
            position: fixed; inset: 0;
            background: var(--void);
            z-index: 200;
            display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 10px;
            transition: opacity 0.8s ease;
        }
        .boot-logo {
            font-family: var(--font-ui);
            font-size: clamp(48px, 10vw, 90px);
            font-weight: 700; letter-spacing: 0.3em; color: #fff;
            margin-bottom: 12px;
            animation: flicker 3s infinite;
        }
        .boot-logo span { color: var(--amber); }
        @keyframes flicker {
            0%,95%,100%{opacity:1} 96%{opacity:.7} 97%{opacity:1} 98%{opacity:.5} 99%{opacity:1}
        }
        .boot-line { font-size: 12px; letter-spacing: 0.15em; color: rgba(255,170,0,0.4); height: 18px; }
        .boot-line.active { color: var(--amber); }
        .boot-line.done   { color: var(--green); }
        .boot-line.done::before  { content: '‚úì '; }
        .boot-line.active::before { content: '> '; animation: blink 0.6s step-end infinite; }
        @keyframes blink { 50%{opacity:0} }
        #boot-bar-wrap { width: 300px; height: 2px; background: rgba(255,170,0,0.15); margin-top: 28px; overflow: hidden; }
        #boot-bar { height: 100%; background: var(--amber); width: 0%; transition: width .3s ease; box-shadow: 0 0 10px var(--amber); }

        /* ‚îÄ‚îÄ CORNER BRACKETS ‚îÄ‚îÄ */
        .bracket { position: fixed; width: 22px; height: 22px; z-index: 50; pointer-events: none; }
        .bracket-tl { top:16px; left:16px;  border-top: 1px solid var(--amber); border-left: 1px solid var(--amber); }
        .bracket-tr { top:16px; right:16px; border-top: 1px solid var(--amber); border-right: 1px solid var(--amber); }
        .bracket-bl { bottom:16px; left:16px;  border-bottom: 1px solid var(--amber); border-left: 1px solid var(--amber); }
        .bracket-br { bottom:16px; right:16px; border-bottom: 1px solid var(--amber); border-right: 1px solid var(--amber); }

        /* ‚îÄ‚îÄ TELEMETRY PANEL ‚îÄ‚îÄ */
        #telemetry {
            position: fixed; top: 36px; left: 36px; z-index: 50;
            width: 310px; display: none; flex-direction: column;
            background: rgba(1,5,12,0.97);
            border: 1px solid var(--border);
            border-radius: 4px;
            padding: 18px 20px;
            backdrop-filter: blur(20px);
            box-shadow: 0 0 60px rgba(0,0,0,0.95), 0 0 30px rgba(255,204,0,0.06);
        }
        .panel-header {
            display: flex; align-items: center; gap: 10px;
            padding-bottom: 14px; border-bottom: 1px solid var(--border); margin-bottom: 14px;
        }
        .live-dot {
            width: 9px; height: 9px; border-radius: 50%;
            background: var(--green); box-shadow: 0 0 12px var(--green), 0 0 24px rgba(0,255,153,0.4);
            animation: pulse-live 2s ease-in-out infinite; flex-shrink: 0;
        }
        @keyframes pulse-live {
            0%,100%{opacity:1;box-shadow:0 0 12px var(--green),0 0 24px rgba(0,255,153,0.4)} 50%{opacity:.4;box-shadow:none}
        }
        .panel-title {
            font-family: var(--font-ui); font-size: 12px; letter-spacing: 0.35em;
            font-weight: 700; color: #ffffff; text-transform: uppercase; flex: 1;
        }
        .mission-id { font-size: 10px; letter-spacing: 0.1em; color: var(--amber); opacity: 0.7; }

        .telem-row {
            display: flex; align-items: center; justify-content: space-between;
            padding: 10px 0; border-bottom: 1px solid var(--border-dim); gap: 12px;
        }
        .telem-row:last-child { border-bottom: none; }
        .telem-key {
            font-size: 10px; letter-spacing: 0.2em;
            color: var(--amber); opacity: 0.7; text-transform: uppercase; flex-shrink: 0;
        }
        .telem-val { font-size: 18px; color: #fff; text-align: right; line-height: 1.1; }
        .telem-val.big {
            font-size: 24px; color: var(--amber);
            font-family: var(--font-ui); font-weight: 700;
            text-shadow: 0 0 12px rgba(255,204,0,0.5);
        }
        .telem-unit {
            display: block; font-size: 9px;
            color: rgba(255,255,255,0.45); letter-spacing: 0.1em; margin-top: 2px;
        }

        /* ‚îÄ‚îÄ VISIBILITY BADGE ‚Äî SUPER PROMINENT ‚îÄ‚îÄ */
        .vis-row {
            display: flex; align-items: center; justify-content: space-between;
            padding: 12px 0; border-bottom: 1px solid var(--border-dim);
        }
        .vis-label-key {
            font-size: 10px; letter-spacing: 0.2em;
            color: var(--amber); opacity: 0.7; text-transform: uppercase;
        }
        #vis-badge {
            font-size: 14px; letter-spacing: 0.15em; padding: 8px 20px;
            border-radius: 4px; text-transform: uppercase;
            font-family: var(--font-ui); font-weight: 700;
            display: inline-flex; align-items: center; gap: 8px;
        }
        .vis-day {
            background: rgba(255,220,0,0.2);
            color: #ffdd00;
            border: 2px solid #ffdd00;
            text-shadow: 0 0 10px #ffdd00;
            box-shadow: 0 0 20px rgba(255,220,0,0.35), inset 0 0 12px rgba(255,220,0,0.1);
        }
        .vis-eclip {
            background: rgba(60,120,255,0.2);
            color: #7aabff;
            border: 2px solid #7aabff;
            text-shadow: 0 0 10px #7aabff;
            box-shadow: 0 0 20px rgba(100,150,255,0.35), inset 0 0 12px rgba(100,150,255,0.1);
        }

        /* ‚îÄ‚îÄ REFRESH BAR ‚îÄ‚îÄ */
        #refresh-wrap { margin-top: 14px; padding-top: 12px; border-top: 1px solid var(--border-dim); }
        .refresh-label {
            font-size: 10px; letter-spacing: 0.2em; color: var(--amber); opacity: 0.6;
            text-transform: uppercase; margin-bottom: 8px;
            display: flex; justify-content: space-between;
        }
        #countdown { color: #fff; opacity: 1; }
        #refresh-bar-wrap { height: 3px; background: rgba(255,204,0,0.15); overflow: hidden; border-radius: 2px; }
        #refresh-bar { height: 100%; background: var(--amber); width: 100%; box-shadow: 0 0 10px var(--amber); transition: width 1s linear; }

        /* ‚îÄ‚îÄ ERROR ‚îÄ‚îÄ */
        #error-msg {
            display: none; margin-top: 12px; font-size: 11px; letter-spacing: 0.1em;
            color: var(--red); padding: 10px 14px;
            border: 1px solid rgba(255,85,85,0.5); background: rgba(255,85,85,0.1);
            border-radius: 3px;
        }
        #error-msg::before { content: '‚ö† '; }

        /* ‚îÄ‚îÄ MISSION CLOCK ‚îÄ‚îÄ */
        #mission-clock {
            position: fixed; top: 36px; left: 50%; transform: translateX(-50%);
            z-index: 50; text-align: center; display: none;
        }
        .clock-label { font-size: 9px; letter-spacing: 0.35em; color: var(--amber); opacity: 0.5; text-transform: uppercase; margin-bottom: 4px; }
        .clock-time { font-family: var(--font-ui); font-size: clamp(20px,2.5vw,30px); font-weight: 300; color: rgba(255,255,255,0.35); letter-spacing: 0.1em; }

        /* ‚îÄ‚îÄ CONTROLS HINT ‚îÄ‚îÄ */
        #controls-hint {
            position: fixed; bottom: 36px; left: 50%; transform: translateX(-50%);
            z-index: 50; display: none; gap: 24px; align-items: center;
        }
        .hint-item { font-size: 10px; letter-spacing: 0.2em; color: rgba(255,204,0,0.5); text-transform: uppercase; white-space: nowrap; }
        .hint-sep  { width: 1px; height: 12px; background: rgba(255,204,0,0.25); }

        /* ‚îÄ‚îÄ ORBITAL PANEL ‚îÄ‚îÄ */
        #orbital-panel {
            position: fixed; top: 36px; right: 36px; z-index: 50; width: 210px;
            display: none; flex-direction: column;
            background: rgba(1,5,12,0.97);
            border: 1px solid var(--border); border-radius: 4px;
            padding: 16px 18px; backdrop-filter: blur(20px);
            box-shadow: 0 0 60px rgba(0,0,0,0.95);
            text-align: right;
        }
        .orbital-title {
            font-size: 10px; letter-spacing: 0.3em; color: var(--amber); opacity: 0.6;
            text-transform: uppercase; margin-bottom: 12px; padding-bottom: 10px;
            border-bottom: 1px solid var(--border-dim);
        }
        .orbital-row { padding: 8px 0; border-bottom: 1px solid var(--border-dim); }
        .orbital-row:last-child { border-bottom: none; }
        .orbital-key { font-size: 9px; letter-spacing: 0.2em; color: var(--amber); opacity: 0.55; text-transform: uppercase; }
        .orbital-val { font-family: var(--font-ui); font-size: 22px; font-weight: 700; color: var(--teal); line-height: 1.2;
            text-shadow: 0 0 14px rgba(0,255,255,0.6); }

        /* ‚îÄ‚îÄ ISS LABEL ‚îÄ‚îÄ */
        #iss-label {
            position: fixed; z-index: 50; pointer-events: none; display: none;
            flex-direction: column; align-items: center; gap: 4px;
            transform: translate(-50%, -120%);
        }
        .iss-label-text { font-size: 11px; letter-spacing: 0.2em; color: var(--teal); text-transform: uppercase; white-space: nowrap; text-shadow: 0 0 14px var(--teal), 0 0 28px rgba(0,255,255,0.4); font-weight: 700; }
        .iss-label-line { width: 1px; height: 22px; background: linear-gradient(to bottom, var(--teal), transparent); }

        /* ‚îÄ‚îÄ OBJECT WATERMARK ‚îÄ‚îÄ */
        #object-info { position: fixed; bottom: 36px; right: 36px; z-index: 50; display: none; flex-direction: column; align-items: flex-end; gap: 2px; }
        .obj-name { font-family: var(--font-ui); font-size: clamp(32px,4vw,52px); font-weight: 700; color: rgba(255,255,255,0.05); letter-spacing: 0.05em; line-height: 1; }
        .obj-sub  { font-size: 9px; letter-spacing: 0.25em; color: rgba(255,204,0,0.25); text-transform: uppercase; }

        /* ‚îÄ‚îÄ MOBILE DRAWER ‚îÄ‚îÄ */
        #mobile-handle {
            display: none;
            position: fixed; bottom: 0; left: 0; right: 0; z-index: 60;
            background: rgba(1,5,12,0.97);
            border-top: 1px solid var(--border);
            border-radius: 16px 16px 0 0;
            padding: 10px 20px 14px;
            cursor: pointer;
            backdrop-filter: blur(20px);
            box-shadow: 0 -4px 40px rgba(0,0,0,0.8);
        }
        #mobile-handle-grip {
            width: 36px; height: 3px; border-radius: 2px;
            background: rgba(255,204,0,0.4); margin: 0 auto 10px;
        }
        #mobile-handle-row {
            display: flex; align-items: center; justify-content: space-between; gap: 8px;
        }
        .mh-item { display: flex; flex-direction: column; align-items: center; gap: 2px; flex: 1; }
        .mh-key  { font-size: 8px; letter-spacing: 0.2em; color: var(--amber); opacity: 0.6; text-transform: uppercase; }
        .mh-val  { font-family: var(--font-ui); font-size: 16px; font-weight: 700; color: #fff; }
        .mh-sep  { width: 1px; height: 28px; background: rgba(255,204,0,0.2); }
        #mobile-chevron {
            font-size: 14px; color: var(--amber); opacity: 0.6;
            transition: transform 0.35s ease;
            position: absolute; right: 18px; bottom: 16px;
        }
        #mobile-chevron.open { transform: rotate(180deg); }

        @media (max-width: 700px) {
            #telemetry {
                top: auto; bottom: 0; left: 0; right: 0;
                width: 100%; border-radius: 0;
                transform: translateY(100%);
                transition: transform 0.4s cubic-bezier(0.4,0,0.2,1);
                padding: 16px 16px 24px;
                border-left: none; border-right: none; border-bottom: none;
                max-height: 72vh; overflow-y: auto;
                border-top: 1px solid var(--border);
                border-radius: 16px 16px 0 0;
            }
            #telemetry.drawer-open {
                transform: translateY(0);
            }
            .telem-val.big { font-size: 22px; }
            .telem-val     { font-size: 17px; }
            .telem-key     { font-size: 11px; }
            #vis-badge     { font-size: 15px; padding: 10px 22px; }
            .vis-row       { padding: 14px 0; }
            .telem-row     { padding: 12px 0; }
            #orbital-panel, #mission-clock, #object-info, #controls-hint { display: none !important; }
            .bracket { display: none; }
            #mobile-handle { display: block; }
        }
    </style>
</head>
<body>

<div class="bracket bracket-tl"></div>
<div class="bracket bracket-tr"></div>
<div class="bracket bracket-bl"></div>
<div class="bracket bracket-br"></div>

<!-- Boot -->
<div id="boot-screen">
    <div class="boot-logo">IS<span>S</span></div>
    <div class="boot-line" id="b1">INITIALIZING TRACKING SYSTEMS</div>
    <div class="boot-line" id="b2">LOADING EARTH TEXTURE DATA</div>
    <div class="boot-line" id="b3">CONNECTING TO TELEMETRY FEED</div>
    <div class="boot-line" id="b4">ACQUIRING ORBITAL LOCK</div>
    <div id="boot-bar-wrap"><div id="boot-bar"></div></div>
</div>

<!-- Mission clock -->
<div id="mission-clock">
    <div class="clock-label">Session Elapsed</div>
    <div class="clock-time" id="clock-display">--:--:--</div>
</div>

<!-- Mobile drawer handle (visible on small screens only) -->
<div id="mobile-handle" onclick="toggleDrawer()">
    <div id="mobile-handle-grip"></div>
    <div id="mobile-handle-row">
        <div class="mh-item">
            <span class="mh-key">Lat</span>
            <span class="mh-val" id="mh-lat">--</span>
        </div>
        <div class="mh-sep"></div>
        <div class="mh-item">
            <span class="mh-key">Lon</span>
            <span class="mh-val" id="mh-lon">--</span>
        </div>
        <div class="mh-sep"></div>
        <div class="mh-item">
            <span class="mh-key">Alt km</span>
            <span class="mh-val" id="mh-alt" style="color:var(--teal)">--</span>
        </div>
        <div class="mh-sep"></div>
        <div class="mh-item">
            <span class="mh-key">Status</span>
            <span class="mh-val" id="mh-vis" style="font-size:12px">--</span>
        </div>
    </div>
    <div id="mobile-chevron">‚ñ≤</div>
</div>

<!-- Telemetry -->
<div id="telemetry">
    <div class="panel-header">
        <div class="live-dot"></div>
        <div class="panel-title">ISS Telemetry</div>
        <div class="mission-id">ZARYA ¬∑ 25544</div>
    </div>
    <div class="telem-row">
        <div class="telem-key">Latitude</div>
        <div class="telem-val big" id="lat">--</div>
    </div>
    <div class="telem-row">
        <div class="telem-key">Longitude</div>
        <div class="telem-val big" id="lon">--</div>
    </div>
    <div class="telem-row">
        <div class="telem-key">Altitude</div>
        <div class="telem-val">
            <span id="alt" style="font-size:24px;color:var(--teal);font-family:var(--font-ui);font-weight:700;text-shadow:0 0 14px var(--teal),0 0 28px rgba(0,255,255,0.4)">--</span>
            <span class="telem-unit">KILOMETERS</span>
        </div>
    </div>
    <div class="telem-row">
        <div class="telem-key">Velocity</div>
        <div class="telem-val">
            <span id="vel" style="font-size:24px;color:var(--teal);font-family:var(--font-ui);font-weight:700;text-shadow:0 0 14px var(--teal),0 0 28px rgba(0,255,255,0.4)">--</span>
            <span class="telem-unit">KM / HOUR</span>
        </div>
    </div>
    <div class="vis-row">
        <div class="vis-label-key">Visibility</div>
        <span id="vis-badge" class="vis-eclip">‚óè Eclipsed</span>
    </div>
    <div class="telem-row" style="border:none;">
        <div class="telem-key">Data As Of</div>
        <div class="telem-val" style="font-size:13px;color:rgba(255,255,255,0.7);" id="time">--</div>
    </div>
    <div id="refresh-wrap">
        <div class="refresh-label"><span>Next update</span><span id="countdown">10s</span></div>
        <div id="refresh-bar-wrap"><div id="refresh-bar"></div></div>
    </div>
    <div id="error-msg">Signal lost. Retrying...</div>
</div>

<!-- Orbital panel -->
<div id="orbital-panel">
    <div class="orbital-title">Orbital Data</div>
    <div class="orbital-row">
        <div class="orbital-key">Inclination</div>
        <div class="orbital-val">51.6¬∞</div>
    </div>
    <div class="orbital-row">
        <div class="orbital-key">Period</div>
        <div class="orbital-val">92.9<span style="font-size:12px;color:rgba(0,255,255,0.5)"> min</span></div>
    </div>
    <div class="orbital-row">
        <div class="orbital-key">Orbits / Day</div>
        <div class="orbital-val">15.5</div>
    </div>
    <div class="orbital-row" style="border:none;">
        <div class="orbital-key">Apogee</div>
        <div class="orbital-val" id="apogee">--</div>
    </div>
</div>

<!-- ISS label -->
<div id="iss-label">
    <div class="iss-label-text">‚ñ≤ ISS</div>
    <div class="iss-label-line"></div>
</div>

<!-- Controls hint -->
<div id="controls-hint">
    <span class="hint-item">Drag ¬∑ Rotate</span>
    <div class="hint-sep"></div>
    <span class="hint-item">Scroll ¬∑ Zoom</span>
    <div class="hint-sep"></div>
    <span class="hint-item">Updates every 10s</span>
</div>

<!-- Watermark -->
<div id="object-info">
    <div class="obj-name">ISS</div>
    <div class="obj-sub">International Space Station</div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/controls/OrbitControls.js"></script>
<script>
    // Mobile drawer toggle
    let drawerOpen = false;
    function toggleDrawer() {
        drawerOpen = !drawerOpen;
        document.getElementById('telemetry').classList.toggle('drawer-open', drawerOpen);
        document.getElementById('mobile-chevron').classList.toggle('open', drawerOpen);
    }
    // Close drawer when tapping the globe canvas
    document.addEventListener('pointerdown', e => {
        if (drawerOpen && !e.target.closest('#telemetry') && !e.target.closest('#mobile-handle')) {
            drawerOpen = false;
            document.getElementById('telemetry').classList.remove('drawer-open');
            document.getElementById('mobile-chevron').classList.remove('open');
        }
    });

    // Boot sequence
    const bootLines = ['b1','b2','b3','b4'];
    const bootBar = document.getElementById('boot-bar');
    let bootStep = 0;
    function runBoot() {
        if (bootStep < bootLines.length) {
            if (bootStep > 0) document.getElementById(bootLines[bootStep-1]).className = 'boot-line done';
            document.getElementById(bootLines[bootStep]).className = 'boot-line active';
            bootBar.style.width = ((bootStep+1)/bootLines.length*100)+'%';
            bootStep++;
            setTimeout(runBoot, 550 + Math.random()*350);
        } else {
            document.getElementById(bootLines[bootLines.length-1]).className = 'boot-line done';
            bootBar.style.width = '100%';
            setTimeout(hideBoot, 500);
        }
    }
    function hideBoot() {
        const boot = document.getElementById('boot-screen');
        boot.style.opacity = '0';
        const isMobile = window.innerWidth <= 700;
        setTimeout(() => {
            boot.style.display = 'none';
            // On mobile: show handle instead of full panel; panel slides in on tap
            if (isMobile) {
                document.getElementById('telemetry').style.display = 'flex';
                // handle is shown via CSS (display:block on mobile)
            } else {
                document.getElementById('telemetry').style.display = 'flex';
                document.getElementById('orbital-panel').style.display = 'flex';
                document.getElementById('mission-clock').style.display = 'block';
                document.getElementById('controls-hint').style.display = 'flex';
                document.getElementById('object-info').style.display = 'flex';
            }
            document.getElementById('iss-label').style.display = 'flex';
        }, 800);
    }
    setTimeout(runBoot, 400);

    // Mission clock
    const startTime = Date.now();
    setInterval(() => {
        const e = Math.floor((Date.now()-startTime)/1000);
        const h = String(Math.floor(e/3600)).padStart(2,'0');
        const m = String(Math.floor((e%3600)/60)).padStart(2,'0');
        const s = String(e%60).padStart(2,'0');
        document.getElementById('clock-display').textContent = `${h}:${m}:${s}`;
    }, 1000);

    // Three.js
    let scene, camera, renderer, controls, earth, earthGroup, issMesh, issGlow, sunLight, orbitLine;
    const EARTH_RADIUS = 5;
    const ISS_API_URL  = 'https://api.wheretheiss.at/v1/satellites/25544';
    const orbitHistory = [];
    const MAX_TRAIL    = 120;

    function init() {
        scene  = new THREE.Scene();
        camera = new THREE.PerspectiveCamera(45, window.innerWidth/window.innerHeight, 0.1, 1000);
        camera.position.set(0, 4, 16);

        renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
        renderer.setSize(window.innerWidth, window.innerHeight);
        renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));
        renderer.toneMapping = THREE.ACESFilmicToneMapping;
        renderer.toneMappingExposure = 1.1;
        document.body.appendChild(renderer.domElement);

        controls = new THREE.OrbitControls(camera, renderer.domElement);
        controls.enableDamping = true; controls.dampingFactor = 0.05;
        controls.minDistance = 6.5; controls.maxDistance = 40;
        controls.enablePan = false;
        controls.autoRotate = false;

        scene.add(new THREE.AmbientLight(0x111133, 0.3));
        sunLight = new THREE.DirectionalLight(0xfff5e0, 2.2);
        scene.add(sunLight);

        const loader = new THREE.TextureLoader();
        const earthMat = new THREE.MeshPhongMaterial({
            map:         loader.load('https://unpkg.com/three-globe/example/img/earth-blue-marble.jpg'),
            bumpMap:     loader.load('https://unpkg.com/three-globe/example/img/earth-topology.png'),
            bumpScale:   0.06,
            specularMap: loader.load('https://unpkg.com/three-globe/example/img/earth-water.png'),
            specular:    new THREE.Color(0x334466), shininess: 20,
            emissiveMap: loader.load('https://unpkg.com/three-globe/example/img/earth-night.jpg'),
            emissive:    new THREE.Color(0xffddaa),
            emissiveIntensity: 0.9
        });
        earth = new THREE.Mesh(new THREE.SphereGeometry(EARTH_RADIUS,64,64), earthMat);
        earthGroup = new THREE.Group();
        earthGroup.add(earth);
        scene.add(earthGroup);

        // Atmosphere
        earthGroup.add(new THREE.Mesh(
            new THREE.SphereGeometry(EARTH_RADIUS*1.02,64,64),
            new THREE.MeshPhongMaterial({ color:0x4488ff, transparent:true, opacity:0.06 })
        ));

        // ISS dot ‚Äî child of earthGroup so it rotates with the Earth texture
        issMesh = new THREE.Mesh(new THREE.SphereGeometry(0.08,16,16), new THREE.MeshBasicMaterial({ color:0x00e5ff }));
        earthGroup.add(issMesh);
        issGlow = new THREE.Mesh(new THREE.SphereGeometry(0.2,16,16), new THREE.MeshBasicMaterial({ color:0x00e5ff, transparent:true, opacity:0.25 }));
        issMesh.add(issGlow);

        // Orbit trail ‚Äî child of earthGroup so it rotates with the Earth
        const trailGeo = new THREE.BufferGeometry();
        trailGeo.setAttribute('position', new THREE.BufferAttribute(new Float32Array(MAX_TRAIL*3), 3));
        trailGeo.setDrawRange(0,0);
        orbitLine = new THREE.Line(trailGeo, new THREE.LineBasicMaterial({ color:0x00e5ff, transparent:true, opacity:0.3 }));
        earthGroup.add(orbitLine);

        // Stars
        const starPos = new Float32Array(5000*3);
        for (let i=0; i<5000*3; i++) starPos[i] = (Math.random()-.5)*300;
        const starGeo = new THREE.BufferGeometry();
        starGeo.setAttribute('position', new THREE.BufferAttribute(starPos,3));
        scene.add(new THREE.Points(starGeo, new THREE.PointsMaterial({ color:0xffffff, size:0.12 })));

        window.addEventListener('resize', () => {
            camera.aspect = window.innerWidth/window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        });

        fetchISSData();
        startRefreshCycle();
        animate();
    }

    // Convert lat/lon to a local 3D position (used for ISS inside earthGroup)
    function latLonToVec3(lat, lon, r) {
        const phi   = (90-lat)*(Math.PI/180);
        const theta = (lon+180)*(Math.PI/180);
        return new THREE.Vector3(
            -(r*Math.sin(phi)*Math.cos(theta)),
             (r*Math.cos(phi)),
             (r*Math.sin(phi)*Math.sin(theta))
        );
    }

    // Convert lat/lon to world-space position (used for sun, ignores Earth rotation)
    function latLonToWorld(lat, lon, r) {
        const phi   = (90-lat)*(Math.PI/180);
        const theta = lon*(Math.PI/180);
        return new THREE.Vector3(
             r*Math.sin(phi)*Math.cos(theta),
             r*Math.cos(phi),
             r*Math.sin(phi)*Math.sin(theta)
        );
    }

    let refreshTimer = 10;
    const refreshBar  = document.getElementById('refresh-bar');
    const countdownEl = document.getElementById('countdown');

    function startRefreshCycle() {
        refreshTimer = 10;
        refreshBar.style.transition = 'none';
        refreshBar.style.width = '100%';
        setTimeout(() => { refreshBar.style.transition = 'width 10s linear'; refreshBar.style.width = '0%'; }, 50);
        const tick = setInterval(() => {
            refreshTimer--;
            countdownEl.textContent = refreshTimer + 's';
            if (refreshTimer <= 0) { clearInterval(tick); fetchISSData(); startRefreshCycle(); }
        }, 1000);
    }

    async function fetchISSData() {
        try {
            const res = await fetch(ISS_API_URL);
            if (!res.ok) throw new Error('HTTP '+res.status);
            const d = await res.json();

            document.getElementById('lat').textContent  = d.latitude.toFixed(4)+'¬∞';
            document.getElementById('lon').textContent  = d.longitude.toFixed(4)+'¬∞';
            document.getElementById('alt').textContent  = d.altitude.toFixed(1);
            document.getElementById('vel').textContent  = Math.round(d.velocity).toLocaleString();
            const ts = new Date(d.timestamp*1000);
            const localTime = ts.toLocaleTimeString([], {hour:'2-digit', minute:'2-digit', second:'2-digit'});
            const utcTime   = ts.toUTCString().match(/\d{2}:\d{2}:\d{2}/)[0];
            document.getElementById('time').textContent = localTime + ' ¬∑ ' + utcTime + ' UTC';
            document.getElementById('apogee').textContent = (d.altitude+8).toFixed(0)+' km';
            document.getElementById('error-msg').style.display = 'none';

            const altScale = EARTH_RADIUS*(1+d.altitude/6371);
            const issPos   = latLonToVec3(d.latitude, d.longitude, altScale);
            issMesh.position.copy(issPos);
            orbitHistory.push(issPos.clone());
            if (orbitHistory.length > MAX_TRAIL) orbitHistory.shift();
            updateTrail();

            const sunPos = latLonToWorld(d.solar_lat, d.solar_lon, EARTH_RADIUS*12);
            sunLight.position.copy(sunPos);

            // Geometric eclipse check using consistent world-space coords for both ISS and sun.
            // latLonToWorld is used for both so the coordinate frames match.
            const issWorld = latLonToWorld(d.latitude, d.longitude, altScale);
            const sunDir   = sunPos.clone().normalize();
            const proj     = issWorld.dot(sunDir);      // component along sun axis
            const perpDist = issWorld.clone().addScaledVector(sunDir, -proj).length(); // dist from shadow axis
            const inShadow = proj < 0 && perpDist < EARTH_RADIUS;

            const vis = document.getElementById('vis-badge');
            if (!inShadow) {
                vis.textContent = '‚òÄ Daylight';
                vis.className = 'vis-day';
            } else {
                vis.textContent = '‚óè Eclipsed';
                vis.className = 'vis-eclip';
            }

            // Mini handle (mobile)
            document.getElementById('mh-lat').textContent = d.latitude.toFixed(2)+'¬∞';
            document.getElementById('mh-lon').textContent = d.longitude.toFixed(2)+'¬∞';
            document.getElementById('mh-alt').textContent = d.altitude.toFixed(0);
            document.getElementById('mh-vis').textContent = !inShadow ? '‚òÄ Day' : '‚óè Night';
        } catch(e) {
            console.error(e);
            document.getElementById('error-msg').style.display = 'block';
        }
    }

    function updateTrail() {
        const pos = orbitLine.geometry.attributes.position.array;
        for (let i=0; i<orbitHistory.length; i++) {
            pos[i*3]=orbitHistory[i].x; pos[i*3+1]=orbitHistory[i].y; pos[i*3+2]=orbitHistory[i].z;
        }
        orbitLine.geometry.setDrawRange(0, orbitHistory.length);
        orbitLine.geometry.attributes.position.needsUpdate = true;
    }

    function updateEarthRotation() {
        const now = new Date();
        const utcHours = now.getUTCHours() + now.getUTCMinutes()/60 + now.getUTCSeconds()/3600;
        // Earth rotates 360¬∞ in 24 hrs; texture offset so 0¬∞ lon aligns correctly
        earthGroup.rotation.y = (utcHours / 24) * Math.PI * 2 - Math.PI/2;
    }

    const issLabel = document.getElementById('iss-label');
    function updateLabel() {
        if (!issMesh) return;
        // Get ISS world position (it's inside earthGroup which rotates)
        const worldPos = new THREE.Vector3();
        issMesh.getWorldPosition(worldPos);
        const v = worldPos.clone().project(camera);
        const x = (v.x*.5+.5)*window.innerWidth;
        const y = (-v.y*.5+.5)*window.innerHeight;
        if (v.z < 1) { issLabel.style.left=x+'px'; issLabel.style.top=y+'px'; issLabel.style.opacity='1'; }
        else { issLabel.style.opacity='0'; }
    }

    let glowT = 0;
    function animate() {
        requestAnimationFrame(animate);
        glowT += 0.04;
        if (issGlow) {
            issGlow.material.opacity = 0.15+0.15*Math.sin(glowT);
            issGlow.scale.setScalar(1+0.2*Math.sin(glowT*0.8));
        }
        updateEarthRotation();
        controls.update();
        updateLabel();
        renderer.render(scene, camera);
    }

    window.onload = init;
</script>
</body>
</html>